/* ============================================
   TRADING TERMINAL BASE - FLUID RESPONSIVE
   Refactored: Position panel lớn hơn, Chart nhỏ hơn
   ============================================ */

/* Footer height variables */
:root {
  --footer-height: 20px;
}

@media (min-width: 2400px) {
  :root {
    --footer-height: 22px;
  }
}

@media (min-width: 3200px) {
  :root {
    --footer-height: 24px;
  }
}

.trading-terminal {
  display: flex;
  flex-direction: column;
  height: calc(100dvh - 4rem);
  /* ✅ Không set width để tự động fill không gian của parent */
  background: var(--bg-workspace, #0b1426);
  overflow: hidden;
}

.trading-header {
  flex-shrink: 0;
  width: 100%;
  background: var(--bg-panel, #1e293b);
  border-bottom: 1px solid var(--border-panel, rgba(51, 65, 85, 0.5));
  z-index: var(--z-header, 40);
}

/* ============================================
   TRADING WORKSPACE - FLUID RESPONSIVE LAYOUT
   ============================================ */

.trading-workspace {
  flex: 1 1 0;
  display: grid;
  grid-template-columns: 1fr var(--form-width, minmax(180px, 320px));
  min-height: 0;
  overflow: hidden;
  width: 100%;
  max-width: 100%;
  gap: 0;
}

/* Custom scrollbar for workspace */
.trading-workspace::-webkit-scrollbar {
  width: var(--scrollbar-width, 8px);
}

.trading-workspace::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.3);
}

.trading-workspace::-webkit-scrollbar-thumb {
  background: rgba(71, 85, 105, 0.6);
  border-radius: var(--trading-radius-md, 4px);
}

.trading-workspace::-webkit-scrollbar-thumb:hover {
  background: rgba(100, 116, 139, 0.8);
}

/* ===== LEFT SECTION - FLEX COLUMN ===== */
.workspace-left-columns {
  display: flex;
  flex-direction: column;
  min-width: 0;
  overflow: hidden;
  background: var(--bg-panel, #1e293b);
  height: 100%;
  min-height: 0;
}

/* ============================================
   ✅ TOP ROW: Chart + OrderBook
   Chiếm phần nhỏ hơn để Position panel có nhiều chỗ hơn
   ============================================ */
.workspace-chart-orderbook-row {
  display: grid;
  grid-template-columns: 1fr var(--orderbook-width, 320px);
  flex: 0 0 auto; /* ✅ KHÔNG GROW - chiều cao cố định */
  height: 50vh; /* ✅ Mặc định 50% viewport */
  min-height: 280px;
  max-height: 55vh;
  gap: 0;
  overflow: hidden;
}

/* ============================================
   ✅ POSITION PANEL - FILL REMAINING SPACE
   ============================================ */
.positions-panel {
  flex: 1 1 auto; /* ✅ GROW để fill không gian còn lại */
  min-height: var(--position-panel-collapsed, 44px);
  border-top: 1px solid var(--border-panel, rgba(51, 65, 85, 0.5));
  border-bottom: none;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.positions-panel.is-open {
  flex: 1 1 auto; /* ✅ Fill tất cả không gian còn lại */
  min-height: 200px;
  overflow: hidden;
}

/* ===== RIGHT COLUMN: Trading Form - STICKY ===== */
.trading-form-panel {
  width: 100%;
  min-width: clamp(180px, 9.375vw, 240px);
  max-width: clamp(280px, 16.667vw, 400px);
  display: flex;
  flex-direction: column;
  background: var(--bg-panel, #1e293b);
  border-left: 1px solid var(--border-panel, rgba(51, 65, 85, 0.5));
  overflow: hidden;
  position: sticky;
  top: 0;
  height: 100%;
}

.trading-form-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  max-height: 100%;
}

/* ============================================
   POSITION TABLE - INTERNAL SCROLL
   ============================================ */

.position-panel-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  width: 100%;
  min-height: 0;
  background: var(--bg-panel, #1e293b);
  overflow: hidden;
}

.trading-positions-table-container {
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow-x: auto;
  overflow-y: auto;
}

/* ✅ Sticky header cho table */
.trading-positions table thead,
.position-table thead {
  position: sticky;
  top: 0;
  background: var(--bg-panel, #1e293b);
  z-index: 10;
}

.trading-positions table thead th,
.position-table thead th {
  background: var(--bg-panel, #1e293b);
}

/* Custom scrollbar cho position table */
.trading-positions-table-container::-webkit-scrollbar {
  width: var(--scrollbar-width-thin, 6px);
  height: var(--scrollbar-width-thin, 6px);
}

.trading-positions-table-container::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.3);
}

.trading-positions-table-container::-webkit-scrollbar-thumb {
  background: rgba(71, 85, 105, 0.5);
  border-radius: var(--trading-radius-sm, 3px);
}

.trading-positions-table-container::-webkit-scrollbar-thumb:hover {
  background: rgba(100, 116, 139, 0.7);
}

/* ============================================
   WIDTH-BASED RESPONSIVE BREAKPOINTS
   ============================================ */

/* Mobile (< 768px) */
@media (max-width: 767px) {
  .trading-terminal {
    padding-bottom: 52px;
  }

  .trading-workspace {
    grid-template-columns: 1fr;
    overflow-y: visible;
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr;
    height: 45vh;
    min-height: 280px;
    max-height: 400px;
  }
  
  .orderbook-panel {
    display: none !important;
  }
  
  .trading-form-panel {
    position: fixed !important;
    bottom: 32px;
    left: 0;
    right: 0;
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    max-height: calc(85vh - 32px);
    background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96)) !important;
    z-index: var(--z-trading-tab, 80);
    transform: translateY(calc(100% - 52px)) !important;
    transition: transform var(--transition-panel, 0.3s ease);
  }
  
  .trading-form-panel.is-open {
    transform: translateY(0) !important;
  }
  
  /* ===== MOBILE HEADER STYLING ===== */
  .trading-form-mobile-header {
    display: flex !important;
    position: relative;
    min-height: 52px;
    padding: 14px 16px !important;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95)) !important;
    backdrop-filter: blur(12px) !important;
    -webkit-backdrop-filter: blur(12px) !important;
    border-bottom: 1px solid rgba(71, 85, 105, 0.3) !important;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s ease;
  }
  
  .trading-form-mobile-header::before {
    content: '';
    position: absolute;
    top: 6px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 4px;
    background: rgba(148, 163, 184, 0.4);
    border-radius: 2px;
  }
  
  .trading-form-mobile-header svg {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .trading-form-panel.is-open .trading-form-mobile-header svg {
    transform: rotate(180deg);
  }
}

/* Tablet (768px - 1023px) */
@media (min-width: 768px) and (max-width: 1023px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(160px, 200px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr;
    height: 42vh;
    min-height: 280px;
    max-height: 380px;
  }
  
  .orderbook-panel {
    display: none !important;
  }
  
  .positions-panel.is-open {
    min-height: 180px;
  }
  
  .trading-form-panel {
    min-width: 160px;
    max-width: 200px;
  }
}

/* ✅ PORTRAIT MODE - Giữ đơn giản, chỉ ẩn orderbook */
@media (orientation: portrait) and (min-width: 768px) {
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr !important;
  }
  
  .orderbook-panel {
    display: none !important;
  }
}

/* Desktop Small (1024px - 1199px) */
@media (min-width: 1024px) and (max-width: 1199px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(180px, 220px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr;
    height: 44vh;
    min-height: 300px;
    max-height: 420px;
  }
  
  .orderbook-panel {
    display: none !important;
  }
  
  .positions-panel.is-open {
    min-height: 200px;
  }
  
  .trading-form-panel {
    min-width: 180px;
    max-width: 220px;
  }
}

/* Desktop Small-Medium (1200px - 1399px) */
@media (min-width: 1200px) and (max-width: 1399px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(200px, 260px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr;
    height: 45vh;
    min-height: 320px;
    max-height: 450px;
  }
  
  .orderbook-panel {
    display: none !important;
  }
  
  .positions-panel.is-open {
    min-height: 220px;
  }
  
  .trading-form-panel {
    min-width: 200px;
    max-width: 260px;
  }
}

/* Desktop Medium (1400px - 1535px) */
@media (min-width: 1400px) and (max-width: 1535px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(220px, 280px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 280px;
    height: 46vh;
    min-height: 340px;
    max-height: 480px;
  }
  
  .orderbook-panel {
    width: 280px;
    min-width: 260px;
  }
  
  .positions-panel.is-open {
    min-height: 240px;
  }
  
  .trading-form-panel {
    min-width: 220px;
    max-width: 280px;
  }
}

/* Desktop Large (1536px - 1919px) */
@media (min-width: 1536px) and (max-width: 1919px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(260px, 320px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 300px;
    height: 48vh;
    min-height: 360px;
    max-height: 500px;
  }
  
  .orderbook-panel {
    width: 300px;
    min-width: 280px;
  }
  
  .positions-panel.is-open {
    min-height: 260px;
  }
  
  .trading-form-panel {
    min-width: 260px;
    max-width: 320px;
  }
}

/* Full HD (1920px - 2399px) */
@media (min-width: 1920px) and (max-width: 2399px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(280px, 340px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 320px;
    height: 48vh;
    min-height: 380px;
    max-height: 520px;
  }
  
  .orderbook-panel {
    width: 320px;
    min-width: 300px;
  }
  
  .positions-panel.is-open {
    min-height: 280px;
  }
  
  .trading-form-panel {
    min-width: 280px;
    max-width: 340px;
  }
}

/* 2K / QHD (2400px - 3199px) */
@media (min-width: 2400px) and (max-width: 3199px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(320px, 400px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 360px;
    height: 45vh; /* ✅ Giảm xuống để Position có nhiều chỗ hơn */
    min-height: 400px;
    max-height: 550px;
  }
  
  .orderbook-panel {
    width: 360px;
    min-width: 340px;
  }
  
  .positions-panel.is-open {
    min-height: 320px;
  }
  
  .trading-form-panel {
    min-width: 320px;
    max-width: 400px;
  }
  
  /* ✅ Font size nhỏ hơn cho 2K */
  .positions-panel,
  .position-panel-content {
    font-size: 12px;
  }
  
  .trading-positions table,
  .position-table {
    font-size: 11px;
  }
}

/* ============================================
   ✅ 4K (3200px+) - TỐI ƯU: Chart nhỏ, Position lớn
   ============================================ */
@media (min-width: 3200px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(380px, 480px);
  }
  
  /* ✅ Chart + OrderBook: chiếm ít không gian hơn */
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 420px;
    height: 42vh; /* ✅ Giảm từ 55vh xuống 42vh */
    min-height: 450px;
    max-height: 600px;
  }
  
  .orderbook-panel {
    width: 420px;
    min-width: 400px;
  }
  
  /* ✅ Position panel: chiếm nhiều không gian hơn */
  .positions-panel.is-open {
    min-height: 400px;
  }
  
  .trading-form-panel {
    min-width: 380px;
    max-width: 480px;
  }
  
  /* ✅ Font size nhỏ hơn cho 4K - tránh quá to */
  .positions-panel,
  .position-panel-content {
    font-size: 11px;
  }
  
  .trading-positions table,
  .position-table {
    font-size: 10px;
  }
  
  .trading-positions table th,
  .position-table th {
    font-size: 9px;
    padding: 6px 8px;
  }
  
  .trading-positions table td,
  .position-table td {
    padding: 5px 8px;
  }
}

/* ============================================
   ✅ 5K+ (3840px+) - ULTRA WIDE
   ============================================ */
@media (min-width: 3840px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(440px, 560px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 480px;
    height: 40vh; /* ✅ Giảm thêm cho màn hình siêu lớn */
    min-height: 500px;
    max-height: 650px;
  }
  
  .orderbook-panel {
    width: 480px;
    min-width: 460px;
  }
  
  .positions-panel.is-open {
    min-height: 500px;
  }
  
  .trading-form-panel {
    min-width: 440px;
    max-width: 560px;
  }
  
  /* ✅ Font size cho 5K */
  .positions-panel,
  .position-panel-content {
    font-size: 10px;
  }
  
  .trading-positions table,
  .position-table {
    font-size: 9px;
  }
  
  .trading-positions table th,
  .position-table th {
    font-size: 8px;
    padding: 5px 6px;
  }
  
  .trading-positions table td,
  .position-table td {
    padding: 4px 6px;
  }
}

/* ============================================
   ✅ 8K (7680px+) - EXTREME RESOLUTION
   ============================================ */
@media (min-width: 7680px) {
  .trading-workspace {
    grid-template-columns: 1fr minmax(600px, 800px);
  }
  
  .workspace-chart-orderbook-row {
    grid-template-columns: 1fr 650px;
    height: 38vh;
    min-height: 600px;
    max-height: 800px;
  }
  
  .orderbook-panel {
    width: 650px;
    min-width: 620px;
  }
  
  .positions-panel.is-open {
    min-height: 650px;
  }
  
  .trading-form-panel {
    min-width: 600px;
    max-width: 800px;
  }
  
  /* ✅ Font size cho 8K */
  .positions-panel,
  .position-panel-content {
    font-size: 9px;
  }
  
  .trading-positions table,
  .position-table {
    font-size: 8px;
  }
}

/* ============================================
   CRITICAL: NO PAGE SCROLL - FIXED LAYOUT
   ============================================ */

.trading-terminal {
  overflow: hidden;
  overflow-x: hidden;
}

.trading-workspace {
  overflow-x: hidden !important;
  max-width: 100% !important;
}

.trading-workspace > * {
  min-width: 0 !important;
}

.chart-panel,
.orderbook-panel,
.trading-form-panel {
  min-width: 0 !important;
  min-height: 0;
  max-width: 100%;
  overflow: hidden;
}

.workspace-left-columns {
  min-width: 0 !important;
  max-width: 100%;
  overflow: hidden;
}

.workspace-chart-orderbook-row {
  min-width: 0 !important;
  max-width: 100%;
  overflow: hidden;
}

.trading-form-content {
  max-width: 100%;
  box-sizing: border-box;
}

.trading-form-content * {
  max-width: 100%;
  box-sizing: border-box;
}

/* ===== Chart container fill parent ===== */
.chart-panel > div {
  height: 100%;
  min-height: 0;
}

.chart-main-container {
  width: 100% !important;
  height: 100% !important;
  min-width: 0;
  min-height: 0;
}

/* ============================================
   MOBILE SCROLL OVERRIDE
   ============================================ */
@media (max-width: 767px) {
  .trading-terminal {
    height: auto !important;
    min-height: calc(100dvh - 4rem);
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
  }

  .trading-workspace {
    height: auto !important;
    min-height: auto !important;
    overflow: visible !important;
  }

  .workspace-left-columns {
    height: auto !important;
    min-height: auto !important;
    overflow: visible !important;
  }

  .workspace-chart-orderbook-row {
    flex-shrink: 0 !important;
    flex: 0 0 auto !important;
  }

  .positions-panel {
    flex: none !important;
    height: auto !important;
    min-height: auto !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .positions-panel.is-open {
    height: auto !important;
    max-height: none !important;
  }

  .position-panel-content {
    height: auto !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .position-mobile-wrapper,
  .position-mobile-content {
    height: auto !important;
    overflow: visible !important;
  }

  .position-mobile-container {
    padding-bottom: 160px !important;
  }
}

/* iOS Safari fix */
@supports (-webkit-touch-callout: none) {
  @media (max-width: 767px) {
    .trading-terminal {
      min-height: -webkit-fill-available;
    }
  }
}

/* Safe area cho iPhone */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  @media (max-width: 767px) {
    .position-mobile-container {
      padding-bottom: calc(160px + env(safe-area-inset-bottom)) !important;
    }
  }
}